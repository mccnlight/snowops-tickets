# SnowOps Ticket Service

Сервис реализует основную часть EPIC‑5 «Тикеты» из продуктового ТЗ. Он предоставляет REST‑эндпойнты для ролей (Акимат, KGU, подрядчики, водители), принимает факты рейсов (камера + GPS), рассчитывает метрики и формирует подсказки навигации для мобильного клиента.

## Что уже реализовано

1. **Жизненный цикл тикета**
   - Статусы: `PLANNED → IN_PROGRESS → COMPLETED → CLOSED`, отмена (`CANCELLED`) возможна до появления фактов.
   - KGU создаёт/отменяет/закрывает тикет, подрядчик завершает его, водитель отмечает «В работе / Завершено» на назначении.
2. **Назначения и рейсы**
   - Подрядчики назначают водителей и технику (`ticket_assignment`).
   - `TripService.Create` автоматически привязывает факт к тикету/назначению по госномеру, текущему водителю и последней GPS‑точке; при отсутствии совпадений создаётся `NO_ASSIGNMENT`.
3. **Метрики**
   - Списки возвращают `ticket` вместе с `metrics` (кол-во рейсов, объём, наличие нарушений).
   - `TicketDetails` агрегирует тикет, метрики, назначения, рейсы и жалобы в одном ответе.
4. **Нарушения**
   - Автоматически выставляются статусы `ROUTE_VIOLATION`, `NO_AREA_WORK`, `NO_EXIT_CAMERA`, `MISMATCH_PLATE`, `SUSPICIOUS_VOLUME`, `NO_ASSIGNMENT` на основе камер и GPS.
5. **Навигация**
   - `/driver/navigation` отдаёт состояние техники (внутри участка/полигона/снаружи), основной маршрут и до четырёх альтернатив. Маршруты строятся имитационно (прямая линия между точками), но интерфейс соответствует ТЗ.

Полная поддержка контрактов, актов, бюджета и реального роутинга лежит в соседних сервисах и находится вне текущего репозитория.

## Структура проекта

```
cmd/ticket-service      — точка входа
internal/auth           — парсинг JWT
internal/http           — роутинг и middleware (Gin)
internal/model          — GORM модели (тикеты, рейсы, техника, геометрия и т.п.)
internal/repository     — работа с БД
internal/service        — бизнес-логика (тикеты, назначения, рейсы, жалобы, навигация)
```

## Основные эндпойнты

| Роль        | Endpoint                                 | Описание                                                   |
|-------------|------------------------------------------|------------------------------------------------------------|
| KGU         | `POST /kgu/tickets`                      | Создать тикет                                              |
|             | `PUT /kgu/tickets/:id/cancel`            | Отменить до появления фактов                               |
|             | `PUT /kgu/tickets/:id/close`             | Закрыть после проверки                                     |
| Подрядчики  | `PUT /contractor/tickets/:id/complete`   | Завершить тикет при выполнении условий                     |
|             | `POST /contractor/tickets/:id/assignments` | Назначить водителя и технику                             |
|             | `DELETE /contractor/assignments/:id`     | Удалить назначение                                         |
| Водители    | `PUT /driver/assignments/:id/mark-in-work` / `mark-completed` | Локальные статусы водителя                    |
|             | `GET /driver/trips`                      | Список его рейсов (в т.ч. по тикету)                       |
|             | `GET /driver/navigation`                 | Навигационная подсказка                                    |
| Все роли    | `GET /{role}/tickets`                    | Список доступных тикетов (+ метрики)                       |
|             | `GET /{role}/tickets/:id`                | Карточка тикета с метриками/назначениями/рейсами/жалобами |

Ответы стандартные: `{"data": ...}` или `{"error": "..."}`; коды ошибок — `400` (валидация), `401`, `403`, `404`, `409`.

## Навигация (пример)

`GET /driver/navigation`

```json
{
  "data": {
    "mode": "TO_POLYGON",
    "vehicle_state": "INSIDE_AREA",
    "primary_route": {
      "label": "Primary",
      "distance_meters": 3200,
      "duration_seconds": 720,
      "points": [
        {"latitude": 51.162, "longitude": 71.467},
        {"latitude": 51.175, "longitude": 71.495}
      ]
    },
    "alternatives": [
      {"label": "Route 2", "distance_meters": 3500, "duration_seconds": 760, "points": [...]}
    ]
  }
}
```

Маршруты пока имитируются, но структура данных соответствует ТЗ.

## Ингест рейсов (входные данные TripService)

`TripService.Create` ожидает событие с необязательными `ticket_id`/`assignment_id` и фактами от камер/GPS. Алгоритм:

1. Парсим все переданные UUID (тикет, назначение, водитель, техника, камера, полигон, события LPR/volume).
2. Если ID нет, пытаемся найти активное назначение по водителю или технике.
3. Если техника неизвестна, ищем по госномеру; подтягиваем дефолтного водителя, участок и полигон.
4. При отсутствии `ticket_id` ищем активный тикет подрядчика для нужного участка.
5. Берём последнюю GPS‑точку (`vehicle_positions`) для определения `inside_cleaning_area`/`inside_polygon`.
6. Выставляем `TripStatus`: `NO_ASSIGNMENT`, `MISMATCH_PLATE`, `SUSPICIOUS_VOLUME`, `NO_EXIT_CAMERA`, `NO_AREA_WORK`, `ROUTE_VIOLATION` и т.д.
7. Сохраняем `trip` и вызываем `TicketService.OnTripCreated` / `TryAutoComplete` для автоматических переходов статусов.

## Разработка

### Требования

- Go 1.23+
- PostgreSQL 15+

### Запуск

```bash
cd deploy
docker compose up -d  # поднимаем PostgreSQL и прочие зависимости

cd ..
APP_ENV=development \
DB_DSN="postgres://postgres:postgres@localhost:5435/tickets_db?sslmode=disable" \
JWT_ACCESS_SECRET="secret-key" \
HTTP_PORT=8080 \
go run ./cmd/ticket-service
```

### Тесты

```bash
go test ./...
```

## Что остаётся вне текущего репозитория

- Организации, контракты, акты, бюджет, минимальные объёмы (отдельные сервисы и БД).
- Реальные пайплайны LPR/volume/GPS (очереди, idempotency, ретраи).
- Настоящая маршрутизация (OSRM/2GIS/Яндекс) и PostGIS‑операции.
- Полный процесс нарушений и обжалований (приложения, комментарии, workflow).

Данный сервис покрывает основную логику EPIC‑5 и может использоваться как демонстрация/референс до подключения остальных подсистем.
